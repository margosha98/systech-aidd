# Conventions для разработки

> **Базовый документ:** [vision.md](vision.md) - полное техническое видение проекта

## Принципы кода

### Обязательные правила
1. **KISS** - максимальная простота, без оверинжиниринга
2. **1 класс = 1 файл** - никаких монолитных файлов
3. **Async-first** - все IO операции только через async/await
4. **Type hints** - типизация обязательна для всех функций/методов
5. **Fail fast** - валидация в начале, ранний raise при ошибках

### Запрещено
- ❌ Абстрактные фабрики и сложные паттерны
- ❌ Преждевременная оптимизация
- ❌ Магические методы без явной необходимости
- ❌ Избыточная модульность

## Архитектура

### Слои (зависимости вниз)
```
Bot Layer → LLM Layer → Storage Layer
```
- Каждый слой знает только о следующем
- Никаких обратных зависимостей

### Структура
- Плоская структура папок
- Минимум вложенности
- Разделение: bot/, llm/, storage/

## Код

### Именование
- Классы: `PascalCase`
- Функции/методы: `snake_case`
- Константы: `UPPER_SNAKE_CASE`
- Приватные: `_prefix`

### Функции
```python
async def get_response(messages: list[Message], system_prompt: str) -> str:
    """Получает ответ от LLM с учетом истории."""
    pass
```
- Docstring для неочевидных функций
- Явные типы возвращаемых значений
- Async по умолчанию для IO

### Обработка ошибок
```python
# Fail fast - валидация сначала
if not messages:
    raise ValueError("Messages list is empty")

# Логируем и пробрасываем дальше
try:
    response = await client.get_response(messages)
except OpenAIError as e:
    logger.error(f"LLM API error: {e}")
    raise
```

### Конфигурация
- Все настройки через `pydantic-settings`
- Секреты только в `.env`
- Значения по умолчанию для опциональных параметров
- Fail fast при отсутствии обязательных параметров

## Логирование

### Уровни
- **INFO** - основные события (старт, получение/отправка сообщений)
- **ERROR** - ошибки API, БД, необработанные исключения
- **DEBUG** - полные тексты запросов/ответов, SQL

### Формат
```python
logger.info(f"Received message: user_id={user_id}, length={len(text)}")
logger.error(f"LLM API error: status={status}, error={error}")
```

## Тестирование

### Что тестировать
- Критичную бизнес-логику (LLM промпты, обработка истории)
- Обработку ошибок
- Валидацию конфигурации

### Что НЕ тестировать
- Тривиальные геттеры/сеттеры
- Внешние библиотеки (aiogram, openai)

### Формат
```python
@pytest.mark.asyncio
async def test_get_response_with_history():
    """Проверяет формирование промпта с историей."""
    # Arrange, Act, Assert
```

## MVP подход

### Реализуем минимум
- Только текстовые сообщения
- Только личные чаты
- История: последние 10 сообщений
- Без retry логики
- Без кэширования

### Не реализуем сейчас
- Медиа/файлы
- Групповые чаты
- Лимиты на пользователя
- Сложная обработка ошибок
- Метрики и мониторинг

